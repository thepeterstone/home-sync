#!/bin/zsh

# We're located in bin/
ROOT=$(cd $(dirname $(dirname $0)); pwd)

main() {
    rm -rf $ROOT/backups; mkdir $ROOT/backups

    for file in $(ls $ROOT/dot-files); do
        backupAndReplace $file
    done

    shellrc="zshrc"
    if [ -z "$(grep 'added by home-sync' ~/.$shellrc)" ]; then
      echo "export PATH=\"\$PATH:$ROOT/bin\" # added by home-sync" >> ~/.$shellrc
      echo "Updating [0;32m$shellrc[0m..."
    fi
}

backupAndReplace() {
    if [ -e $HOME/.$1 ]; then
        DIFF=$(diff -q $HOME/.$1 $ROOT/dot-files/$1)
        if [ $DIFF ]; then
            echo "Updating [0;32m$1[0m..."
            mv $HOME/.$1 $ROOT/backups/$1
            ln -s $ROOT/dot-files/$1 $HOME/.$1
        fi
    else
        # this needs to be forced because -e returns false for a dangling symlink
        echo "Adding [0;32m$1[0m..."
        ln -sf $ROOT/dot-files/$1 $HOME/.$1
    fi
}

main
